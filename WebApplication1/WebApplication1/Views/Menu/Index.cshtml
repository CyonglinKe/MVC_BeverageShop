@model WebApplication1.Controllers.MenuViewModel
@{
    ViewData["Title"] = "èœå–®";
}

<div class="menu-container">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="menu-header text-center mb-5">
        <h1 class="menu-title">ğŸ¹ å–äº†è®Šå¯æ„›é£²æ–™åº—èœå–®</h1>
        <p class="menu-subtitle">ç²¾é¸é£²å“ï¼Œè®“æ‚¨æ¯ä¸€å£éƒ½å……æ»¿å¹¸ç¦</p>
    </div>

    <!-- åˆ†é¡å°èˆª -->
    <div class="category-nav mb-4">
        <div class="row">
            <div class="col-12">
                <div class="category-tabs">
                    <button class="category-tab active" data-category="all">
                        <i class="fas fa-th-large"></i>
                        <span>å…¨éƒ¨</span>
                    </button>
                    @foreach (var category in Model.Categories)
                    {
                        <button class="category-tab" data-category="@category.Id">
                            <i class="@(category.IconClass ?? "fas fa-mug-hot")"></i>
                            <span>@(category.Name ?? "æœªå‘½ååˆ†é¡")</span>
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- é£²å“åˆ—è¡¨ -->
    <div class="drinks-container">
        <!-- æŒ‰åˆ†é¡é¡¯ç¤ºï¼ˆå…¨éƒ¨æ¨¡å¼ï¼‰ -->
        <div id="drinksListGrouped" class="drinks-list-grouped">
            @foreach (var category in Model.Categories)
            {
                var categoryDrinks = Model.AllDrinks.Where(d => d.CategoryId == category.Id).ToList();
                if (categoryDrinks.Any())
                {
                    <div class="category-section" data-category-section="@category.Id">
                        <div class="category-header">
                            <div class="category-header-content">
                                <i class="@(category.IconClass ?? "fas fa-mug-hot")"></i>
                                <h2 class="category-title">@(category.Name ?? "æœªå‘½ååˆ†é¡")</h2>
                                <span class="category-count">@categoryDrinks.Count æ¬¾</span>
                            </div>
                            <div class="category-divider"></div>
                        </div>
                        <div class="row">
                            @foreach (var drink in categoryDrinks)
                            {
                                <div class="col-xl-3 col-lg-4 col-md-6 mb-3 drink-item" data-category="@drink.CategoryId">
                                    <div class="drink-card">
                                        <div class="drink-content">
                                            <div class="drink-header">
                                                <h3 class="drink-name">
                                                    @(drink.Name ?? "æœªå‘½åé£²å“")
                                                    @if (drink.IsSeasonal)
                                                    {
                                                        <span class="seasonal-badge-inline">
                                                            <i class="fas fa-snowflake"></i>
                                                        </span>
                                                    }
                                                </h3>
                                                <div class="drink-price">
                                                    <span class="price">NT$ @drink.Price</span>
                                                </div>
                                            </div>
                                            <p class="drink-description">@(drink.Description ?? "æš«ç„¡æè¿°")</p>
                                            <div class="drink-footer">
                                                <div class="temperature-options">
                                                    @if (drink.IsHot)
                                                    {
                                                        <span class="temp-option hot">
                                                            <i class="fas fa-fire"></i>
                                                        </span>
                                                    }
                                                    @if (drink.IsCold)
                                                    {
                                                        <span class="temp-option cold">
                                                            <i class="fas fa-snowflake"></i>
                                                        </span>
                                                    }
                                                </div>
                                                <button class="btn btn-primary btn-order btn-sm" data-drink-id="@drink.Id">
                                                    <i class="fas fa-cart-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        </div>

        <!-- å–®ä¸€åˆ†é¡é¡¯ç¤ºæ¨¡å¼ï¼ˆé»æ“Šåˆ†é¡æ™‚ä½¿ç”¨ï¼‰ -->
        <div id="drinksListFiltered" class="row" style="display: none;">
            @foreach (var drink in Model.AllDrinks)
            {
                <div class="col-xl-3 col-lg-4 col-md-6 mb-3 drink-item" data-category="@drink.CategoryId">
                    <div class="drink-card">
                        <div class="drink-content">
                            <div class="drink-header">
                                <h3 class="drink-name">
                                    @(drink.Name ?? "æœªå‘½åé£²å“")
                                    @if (drink.IsSeasonal)
                                    {
                                        <span class="seasonal-badge-inline">
                                            <i class="fas fa-snowflake"></i>
                                        </span>
                                    }
                                </h3>
                                <div class="drink-price">
                                    <span class="price">NT$ @drink.Price</span>
                                </div>
                            </div>
                            <p class="drink-description">@(drink.Description ?? "æš«ç„¡æè¿°")</p>
                            <div class="drink-footer">
                                <div class="temperature-options">
                                    @if (drink.IsHot)
                                    {
                                        <span class="temp-option hot">
                                            <i class="fas fa-fire"></i>
                                        </span>
                                    }
                                    @if (drink.IsCold)
                                    {
                                        <span class="temp-option cold">
                                            <i class="fas fa-snowflake"></i>
                                        </span>
                                    }
                                </div>
                                <button class="btn btn-primary btn-order btn-sm" data-drink-id="@drink.Id">
                                    <i class="fas fa-cart-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- ç©ºç‹€æ…‹ -->
    <div class="empty-state text-center" id="emptyState" style="display: none;">
        <div class="empty-icon">
            <i class="fas fa-search"></i>
        </div>
        <h3>æ‰¾ä¸åˆ°ç›¸é—œé£²å“</h3>
        <p>è«‹å˜—è©¦é¸æ“‡å…¶ä»–åˆ†é¡</p>
    </div>
</div>

<!-- åŠ å…¥è³¼ç‰©è»Šé¸é …å½ˆçª— -->
<div class="modal fade" id="addToCartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-mug-hot"></i> <span id="modalDrinkName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modalDrinkId">
                <input type="hidden" id="modalDrinkPrice">

                <!-- æº«åº¦é¸æ“‡ -->
                <div class="option-group">
                    <label class="option-label">æº«åº¦ <span class="required">*</span></label>
                    <div class="option-buttons">
                        <button type="button" class="option-btn" data-option="temperature" data-value="hot">
                            <i class="fas fa-fire"></i> ç†±
                        </button>
                        <button type="button" class="option-btn" data-option="temperature" data-value="cold">
                            <i class="fas fa-snowflake"></i> å†°
                        </button>
                    </div>
                </div>

                <!-- ç”œåº¦é¸æ“‡ -->
                <div class="option-group">
                    <label class="option-label">ç”œåº¦</label>
                    <div class="option-buttons">
                        <button type="button" class="option-btn active" data-option="sweet" data-value="æ­£å¸¸ç³–">æ­£å¸¸ç³–</button>
                        <button type="button" class="option-btn" data-option="sweet" data-value="å°‘ç³–">å°‘ç³–</button>
                        <button type="button" class="option-btn" data-option="sweet" data-value="åŠç³–">åŠç³–</button>
                        <button type="button" class="option-btn" data-option="sweet" data-value="å¾®ç³–">å¾®ç³–</button>
                        <button type="button" class="option-btn" data-option="sweet" data-value="ç„¡ç³–">ç„¡ç³–</button>
                    </div>
                </div>

                <!-- å†°åº¦é¸æ“‡ (åªåœ¨é¸æ“‡å†°é£²æ™‚é¡¯ç¤º) -->
                <div class="option-group" id="iceOptions" style="display: none;">
                    <label class="option-label">å†°åº¦</label>
                    <div class="option-buttons">
                        <button type="button" class="option-btn active" data-option="ice" data-value="æ­£å¸¸å†°">æ­£å¸¸å†°</button>
                        <button type="button" class="option-btn" data-option="ice" data-value="å°‘å†°">å°‘å†°</button>
                        <button type="button" class="option-btn" data-option="ice" data-value="å¾®å†°">å¾®å†°</button>
                        <button type="button" class="option-btn" data-option="ice" data-value="å»å†°">å»å†°</button>
                    </div>
                </div>

                <!-- æ•¸é‡é¸æ“‡ -->
                <div class="option-group">
                    <label class="option-label">æ•¸é‡</label>
                    <div class="quantity-selector">
                        <button type="button" class="qty-btn" onclick="changeModalQty(-1)">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" id="modalQuantity" class="qty-input" value="1" min="1" readonly>
                        <button type="button" class="qty-btn" onclick="changeModalQty(1)">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- åƒ¹æ ¼é¡¯ç¤º -->
                <div class="modal-price">
                    <span>å°è¨ˆï¼š</span>
                    <span class="modal-subtotal">NT$ <span id="modalSubtotal">0</span></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmAddToCart()">
                    <i class="fas fa-cart-plus"></i> ç¢ºèªåŠ å…¥
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // å¾ URL åƒæ•¸è®€å–åˆ†é¡ ID
            const urlParams = new URLSearchParams(window.location.search);
            const categoryIdFromUrl = urlParams.get('categoryId');
            
            // å¦‚æœæœ‰æŒ‡å®šåˆ†é¡ï¼Œè‡ªå‹•é¸ä¸­è©²åˆ†é¡
            if (categoryIdFromUrl) {
                // æ‰¾åˆ°å°æ‡‰çš„åˆ†é¡æŒ‰éˆ•ä¸¦é»æ“Š
                const $targetTab = $(`.category-tab[data-category="${categoryIdFromUrl}"]`);
                if ($targetTab.length > 0) {
                    $('.category-tab').removeClass('active');
                    $targetTab.addClass('active');
                    filterDrinks(categoryIdFromUrl);
                    
                    // å¹³æ»‘æ»¾å‹•åˆ°åˆ†é¡å€åŸŸ
                    setTimeout(function() {
                        $('html, body').animate({
                            scrollTop: $('.category-nav').offset().top - 100
                        }, 500);
                    }, 100);
                }
            }
            
            // åˆ†é¡åˆ‡æ›åŠŸèƒ½
            $('.category-tab').on('click', function() {
                const categoryId = $(this).data('category');
                
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                $('.category-tab').removeClass('active');
                $(this).addClass('active');
                
                // ç¯©é¸é£²å“
                filterDrinks(categoryId);
            });
            
            function filterDrinks(categoryId) {
                const $groupedList = $('#drinksListGrouped');
                const $filteredList = $('#drinksListFiltered');
                const $emptyState = $('#emptyState');
                
                if (categoryId === 'all') {
                    // é¡¯ç¤ºåˆ†çµ„æ¨¡å¼ï¼ˆæŒ‰åˆ†é¡åˆ†çµ„ï¼‰
                    $groupedList.show();
                    $filteredList.hide();
                    $emptyState.hide();
                } else {
                    // é¡¯ç¤ºç¯©é¸æ¨¡å¼ï¼ˆå–®ä¸€åˆ†é¡ï¼‰
                    $groupedList.hide();
                    $filteredList.show();
                    
                    const $drinkItems = $filteredList.find('.drink-item');
                    let visibleCount = 0;
                    
                    $drinkItems.each(function() {
                        const $item = $(this);
                        const itemCategoryId = $item.data('category');
                        
                        if (itemCategoryId == categoryId) {
                            $item.show();
                            visibleCount++;
                        } else {
                            $item.hide();
                        }
                    });
                    
                    // é¡¯ç¤º/éš±è—ç©ºç‹€æ…‹
                    if (visibleCount === 0) {
                        $emptyState.show();
                    } else {
                        $emptyState.hide();
                    }
                }
            }
            
            // åŠ å…¥è³¼ç‰©è»ŠåŠŸèƒ½
            $('.btn-order').on('click', function() {
                const drinkId = $(this).data('drink-id');
                const drinkCard = $(this).closest('.drink-item');
                const drinkName = drinkCard.find('.drink-name').text().trim();
                const drinkPrice = parseFloat(drinkCard.find('.price').text().replace('NT$ ', '').replace(',', ''));

                // è¨­ç½®æ¨¡æ…‹æ¡†è³‡æ–™
                $('#modalDrinkId').val(drinkId);
                $('#modalDrinkName').text(drinkName);
                $('#modalDrinkPrice').val(drinkPrice);
                $('#modalQuantity').val(1);
                
                // é‡ç½®é¸é …
                $('[data-option="temperature"]').removeClass('active');
                $('[data-option="sweet"]').first().addClass('active');
                $('[data-option="ice"]').first().addClass('active');
                $('#iceOptions').hide();
                
                // æ›´æ–°å°è¨ˆ
                updateModalSubtotal();
                
                // é¡¯ç¤ºæ¨¡æ…‹æ¡†
                const modal = new bootstrap.Modal(document.getElementById('addToCartModal'));
                modal.show();
            });

            // é¸é …æŒ‰éˆ•é»æ“Š
            $('.option-btn').on('click', function() {
                const option = $(this).data('option');
                $(`[data-option="${option}"]`).removeClass('active');
                $(this).addClass('active');

                // å¦‚æœæ˜¯æº«åº¦é¸æ“‡ï¼Œæ§åˆ¶å†°åº¦é¸é …é¡¯ç¤º
                if (option === 'temperature') {
                    const temp = $(this).data('value');
                    if (temp === 'cold') {
                        $('#iceOptions').slideDown();
                    } else {
                        $('#iceOptions').slideUp();
                    }
                }
            });
            
            // Toast æç¤ºåŠŸèƒ½
            function showToast(message, type) {
                const toast = $(`
                    <div class="toast ${type}">
                        <i class="fas fa-check-circle"></i>
                        <span>${message}</span>
                    </div>
                `);
                
                $('body').append(toast);
                
                setTimeout(function() {
                    toast.addClass('show');
                }, 100);
                
                setTimeout(function() {
                    toast.removeClass('show');
                    setTimeout(function() {
                        toast.remove();
                    }, 300);
                }, 3000);
            }
        });

        // æ›´æ–°æ¨¡æ…‹æ¡†å°è¨ˆ
        function updateModalSubtotal() {
            const price = parseFloat($('#modalDrinkPrice').val());
            const qty = parseInt($('#modalQuantity').val());
            const subtotal = price * qty;
            $('#modalSubtotal').text(subtotal.toLocaleString());
        }

        // ä¿®æ”¹æ¨¡æ…‹æ¡†æ•¸é‡
        function changeModalQty(change) {
            const input = $('#modalQuantity');
            let qty = parseInt(input.val()) + change;
            if (qty < 1) qty = 1;
            input.val(qty);
            updateModalSubtotal();
        }

        // ç¢ºèªåŠ å…¥è³¼ç‰©è»Š
        function confirmAddToCart() {
            const drinkId = parseInt($('#modalDrinkId').val());
            const drinkName = $('#modalDrinkName').text();
            const price = parseFloat($('#modalDrinkPrice').val());
            const quantity = parseInt($('#modalQuantity').val());
            const temperature = $('[data-option="temperature"].active').data('value');
            const sweetLevel = $('[data-option="sweet"].active').data('value');
            const iceLevel = temperature === 'cold' ? $('[data-option="ice"].active').data('value') : '';

            // é©—è­‰æº«åº¦æ˜¯å¦å·²é¸æ“‡
            if (!temperature) {
                alert('è«‹é¸æ“‡æº«åº¦');
                return;
            }

            const cartItem = {
                drinkId: drinkId,
                drinkName: drinkName,
                price: price,
                quantity: quantity,
                temperature: temperature,
                sweetLevel: sweetLevel,
                iceLevel: iceLevel
            };

            $.ajax({
                url: '@Url.Action("AddToCart", "Cart")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(cartItem),
                success: function(result) {
                    if (result.success) {
                        // é—œé–‰æ¨¡æ…‹æ¡†
                        bootstrap.Modal.getInstance(document.getElementById('addToCartModal')).hide();
                        
                        // é¡¯ç¤ºæˆåŠŸæç¤º
                        showToast(result.message, 'success');
                        
                        // æ›´æ–°è³¼ç‰©è»Šæ•¸é‡
                        updateCartCount();
                    }
                },
                error: function() {
                    alert('åŠ å…¥è³¼ç‰©è»Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            });
        }

        function showToast(message, type) {
            const toast = $(`
                <div class="toast ${type}">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `);
            
            $('body').append(toast);
            
            setTimeout(function() {
                toast.addClass('show');
            }, 100);
            
            setTimeout(function() {
                toast.removeClass('show');
                setTimeout(function() {
                    toast.remove();
                }, 300);
            }, 3000);
        }
    </script>
}

